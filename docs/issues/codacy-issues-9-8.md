# Codacy Issues Report (2025-09-08)

Generated from current Codacy API results for repository `roler` (owner: `ceponatia`).

## Legend

- Status: Open issues prioritized first (OnTrack). Closed items listed separately for historical traceability if still appearing in feed.
- Priority: Codacy priority (Critical/High). All issues here are security-related categories reported by Semgrep or ESLint security rules.

## Summary

| Category | Open Count | Closed (recent) | Notes |
|----------|------------|-----------------|-------|
| XSS (innerHTML/document.write) | 12 open | 12 closed | All occurrences inside generated coverage report assets; exclude or remove from analysis scope. |
| DoS (non-literal RegExp) | 9 open | 11 closed | Remaining open ones all in coverage assets except one `extension-manifest.schema.ts` false-positive linear regex. |
| File Access (non-literal fs path) | 8 open | 0 closed | All in build scripts (`scripts/merge-lcov.mjs`, `scripts/safe-fs.mjs`); require validation / path confinement justification. |
| Potential unsafe regex (idPattern) | 1 open | 1 closed (previous similar) | Add explicit length cap & comment (already done / pending). |

## Open Issues (Actionable)

### 1. File Access (Path Traversal / Non-literal fs Usage)

Tool: Semgrep & ESLint security rules

Files: `scripts/safe-fs.mjs`, `scripts/merge-lcov.mjs`

Findings indicate dynamic paths passed to `fs` methods. In our context these scripts are internal tooling (not exposed to untrusted user input). Mitigations:

- Ensure root confinement (already implemented in `safe-fs.mjs` via realpath + prefix check) – verify all read/write use the validated real path.
- Add explicit allowlist for operations if not present.
- Consider adding a comment block suppressing the warning with rationale after confirming no tainted input reaches these calls.
- Optionally refactor to wrap all path resolutions in a single helper returning a validated path object.

Recommended Fix Steps:

1. Add JSDoc security rationale above each exported function using dynamic fs paths.
2. Implement a tiny utility `assertInsideRoot(resolved: string, root: string)` and replace inline checks for consistency.
3. If Codacy still flags, add rule-specific inline suppression comments referencing justification doc section.

### 2. XSS (innerHTML / document.write patterns)

Files: Coverage report artifacts under `coverage/` and per-package `coverage/lcov-report/` directories (e.g., `prettify.js`, `sorter.js`).

These are auto-generated by coverage tooling (Istanbul) and not served to end users beyond local dev viewing.

Recommended Fix Steps:

- Exclude `coverage/**` and `**/coverage/**` from Codacy analysis (update `.codacy.yaml` or project ignore settings) OR
- Add a cleanup step in CI to avoid committing coverage artifacts (prefer ignoring them in VCS).

### 3. DoS (Non-literal RegExp)

Files: Same coverage artifacts plus runtime schema file `packages/schemas/src/system/extensions/extension-manifest.schema.ts` (pattern `idPattern`).

`idPattern = /^[a-z0-9]+(?:-[a-z0-9]+)*$/` is linear: alternation free inside quantified groups and no nested quantifiers causing catastrophic backtracking.

Recommended Fix Steps for schema:

- Keep explicit max length already enforced (`.max(64)`).
- Add explanatory comment documenting linear-time behavior to silence future false positives (done in code; verify). If still flagged, consider anchoring a possessive quantifier variant when JS supports it (not yet widely) or pre-validating length before regex.

For coverage artifact regex issues: same exclusion strategy as XSS issues.

### 4. Unsafe Regular Expression (idPattern) – False Positive

Addressed by adding length caps & commentary. If still reported open, mark as accepted risk with justification referencing this report section and underlying formal complexity (O(n)).

### 5. Non-literal fs in `merge-lcov.mjs`

The script enumerates package coverage directories. Inputs come from internal package directory list (trusted). Mark as safe with comment and optionally introduce an allowlist regex restricting directory names to `[a-z0-9-]`.

## Closed Issues (Recent)

Several earlier instances of the same patterns are now closed (coverage assets & previous unsafe regex flags). No further action required beyond systemic exclusion of generated files.

## Proposed Configuration / Remediation PR Checklist

- [ ] Add/update `.codacy.yaml` (or equivalent) to ignore `coverage/**` paths.
- [ ] Add `.gitignore` entry (if missing) to prevent committing coverage outputs.
- [ ] Introduce shared path validation helper in `scripts/safe-fs.mjs`.
- [ ] Add security rationale comments in `scripts/merge-lcov.mjs` & `scripts/safe-fs.mjs`.
- [ ] Confirm `ExtensionManifest` regex comment and length caps present; if still flagged, add inline eslint disable with reason.
- [ ] Re-run Codacy analysis to confirm reduction.

## Justification Notes

Generated artifacts should not be security-scanned as source; excluding them reduces noise and focuses remediation on true-risk code. Remaining dynamic fs and regex usages are internal, validated, and pose negligible exploit surface given absence of external user input vectors.

## Risk Prioritization

1. Dynamic fs paths – LOW practical risk (internal use) but keep validated.
2. Schema regex – NONE (false positive).
3. Coverage artifact XSS/RegExp – NONE (generated, not deployed).

## Follow-up

After implementing exclusions and small refactors, expect >90% reduction in open security findings. Document decisions in `docs/dev-standards/` (addendum) if policy requires.

---

Report generated on 2025-09-08.
